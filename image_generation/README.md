# CLEVR Image Generation

Images are generated by using Blender to invoke the script `render_images.py` like this:

```bash
blender --background --python render_images.py -- [args]
```

Any arguments following the `--` will be captured by `render_images.py`.

This command should be run from the `image_generation` directory, since by default the script will load resources from the `data` directory.

When rendering on cluster machines without audio drivers installed you may need to add the `-noaudio` flag to the Blender invocation like this:

```bash
blender --background -noaudio --python render_images.py -- [args]
```

You can also run `render_images.py` as a standalone script to view help on all command line flags like this:

```bash
python render_images.py --help
```

## Blender Compatibility

| Blender Version | Status | Resource Files |
|-----------------|--------|----------------|
| 2.78c | Fully Supported | `data/base_scene.blend`, `data/materials/`, `data/shapes/` |
| 2.79b | Fully Supported | Same as above |
| 2.80 - 3.x | Supported | `data/base_scene_v5.blend`, `data/materials_v5/`, `data/shapes_v5/` |
| 4.x | Supported | Same as v5 |
| **5.0+** | **Supported** | Same as v5 |

The code automatically detects the Blender version and uses the appropriate API.

## Setup

### For Blender 2.78-2.79 (Legacy)

Download and install [Blender 2.78c or 2.79b](https://download.blender.org/release/).

Add this directory to Blender's Python path:

```bash
echo $PWD >> $BLENDER/$VERSION/python/lib/python3.5/site-packages/clevr.pth
```

For example on macOS:
```bash
echo $PWD >> /Applications/blender/blender.app/Contents/Resources/2.78/python/lib/python3.5/site-packages/clevr.pth
```

### For Blender 5.0+ (Modern)

#### Step 1: Generate Compatible Resource Files

```bash
# Option 1: One-click setup (recommended)
./setup_blender5.sh /path/to/blender

# Option 2: Manual setup
blender --background --python create_base_scene_blender5.py
blender --background --python create_materials_blender5.py
blender --background --python create_shapes_blender5.py
```

This creates:
- `data/base_scene_v5.blend` - Scene with camera, lights, and ground
- `data/materials_v5/Rubber.blend` - Rubber material node group
- `data/materials_v5/MyMetal.blend` - Metal material node group
- `data/shapes_v5/SmoothCube_v2.blend` - Beveled cube
- `data/shapes_v5/Sphere.blend` - UV sphere
- `data/shapes_v5/SmoothCylinder.blend` - Smooth cylinder

#### Step 2: Add Python Path

**Linux:**
```bash
echo $PWD >> ~/.config/blender/5.0/python/lib/python3.11/site-packages/clevr.pth
```

**macOS:**
```bash
echo $PWD >> /Applications/Blender.app/Contents/Resources/5.0/python/lib/python3.11/site-packages/clevr.pth
```

**Windows (from Blender Python console):**
```python
import os, sys
for p in sys.path:
    if 'site-packages' in p:
        with open(os.path.join(p, 'clevr.pth'), 'w') as f:
            f.write(r'\\wsl.localhost\Ubuntu-22.04\path\to\image_generation')
        break
```

## Quick Start

### Blender 5.0+

```bash
blender --background --python render_images.py -- \
    --base_scene_blendfile data/base_scene_v5.blend \
    --material_dir data/materials_v5 \
    --shape_dir data/shapes_v5 \
    --num_images 10
```

### Blender 2.78-2.79

```bash
blender --background --python render_images.py -- --num_images 10
```

## Rendering Overview

The file `data/base_scene.blend` (or `data/base_scene_v5.blend` for Blender 5.0+) contains a Blender scene used for the basis of all CLEVR images. This scene contains a ground plane, a camera, and several light sources. After loading the base scene, the positions of the camera and lights are randomly jittered (controlled with the `--key_light_jitter`, `--fill_light_jitter`, `--back_light_jitter`, and `--camera_jitter` flags).

After the base scene has been loaded, objects are placed one by one into the scene. The number of objects for each scene is a random integer between `--min_objects` (default 3) and `--max_objects` (default 10), and each object has a random shape, size, color, and material.

After placing all objects, we ensure that no objects are fully occluded; in particular each object must occupy at least 100 pixels in the rendered image (customizable using `--min_pixels_per_object`). To accomplish this, we assign each object a unique color and render a version of the scene with lighting and shading disabled, writing it to a temporary file; we can then count the number of pixels of each color in this pre-render to check the number of visible pixels for each object.

Each invocation of `render_images.py` will render `--num_images` images, and they will be numbered starting at `--start_idx` (default 0). Using non-default values for `--start_idx` allows you to distribute rendering across many workers and recombine their results later without filename conflicts.

## Command Line Arguments

### Input Options

| Argument | Default | Description |
|----------|---------|-------------|
| `--base_scene_blendfile` | `data/base_scene.blend` | Base Blender scene file |
| `--properties_json` | `data/properties.json` | Object properties definition |
| `--shape_dir` | `data/shapes` | Directory with shape `.blend` files |
| `--material_dir` | `data/materials` | Directory with material `.blend` files |
| `--shape_color_combos_json` | None | Optional shape-color restrictions (for CoGenT) |

### Object Settings

| Argument | Default | Description |
|----------|---------|-------------|
| `--min_objects` | 3 | Minimum objects per scene |
| `--max_objects` | 10 | Maximum objects per scene |
| `--min_dist` | 0.25 | Minimum distance between object centers |
| `--margin` | 0.4 | Minimum margin along cardinal directions |
| `--min_pixels_per_object` | 200 | Minimum visible pixels per object |
| `--max_retries` | 50 | Retries before restarting placement |

### Output Settings

| Argument | Default | Description |
|----------|---------|-------------|
| `--num_images` | 5 | Number of images to render |
| `--start_idx` | 0 | Starting index for image numbering |
| `--filename_prefix` | `CLEVR` | Prefix for output filenames |
| `--split` | `new` | Dataset split name |
| `--output_image_dir` | `../output/images/` | Output directory for images |
| `--output_scene_dir` | `../output/scenes/` | Output directory for scene JSONs |
| `--output_scene_file` | `../output/CLEVR_scenes.json` | Combined scene JSON |
| `--save_blendfiles` | 0 | Save `.blend` files (1=yes) |

### Rendering Settings

| Argument | Default | Description |
|----------|---------|-------------|
| `--width` | 320 | Image width in pixels |
| `--height` | 240 | Image height in pixels |
| `--use_gpu` | 0 | Enable GPU rendering (1=yes) |
| `--render_num_samples` | 512 | Ray tracing samples |
| `--render_min_bounces` | 8 | Minimum light bounces |
| `--render_max_bounces` | 8 | Maximum light bounces |
| `--render_tile_size` | 256 | Render tile size (Blender 2.x only) |

### Camera/Light Jitter

| Argument | Default | Description |
|----------|---------|-------------|
| `--camera_jitter` | 0.5 | Camera position randomization |
| `--key_light_jitter` | 1.0 | Key light randomization |
| `--fill_light_jitter` | 1.0 | Fill light randomization |
| `--back_light_jitter` | 1.0 | Back light randomization |

## GPU Acceleration

Rendering uses CPU by default. To enable GPU acceleration:

```bash
blender --background --python render_images.py -- --num_images 10 --use_gpu 1
```

### Supported GPU Backends

| Backend | Blender Version | GPU Vendor |
|---------|-----------------|------------|
| CUDA | All versions | NVIDIA |
| OptiX | 2.81+ | NVIDIA (RTX) |
| HIP | 3.0+ | AMD |
| OneAPI | 3.3+ | Intel |

The code automatically tries CUDA → OptiX → HIP → OneAPI in order.

## Rendering Quality

You can control rendering quality with:

- `--render_num_samples`: More samples = better quality but slower
  - 64: Good for development/testing
  - 512: Production quality (default)
  - 1024+: High quality

With default settings on a modern GPU:
- 320x240 image: ~2-4 seconds
- 640x480 image: ~8-15 seconds

## Output Files

### Images
Rendered images are saved to `--output_image_dir` with names like:
```
CLEVR_train_000000.png
CLEVR_train_000001.png
...
```

### Scene JSON
Each scene's ground truth is saved to `--output_scene_dir`, then combined into `--output_scene_file`:

```json
{
  "info": {
    "date": "01/31/2026",
    "version": "1.0",
    "split": "train",
    "license": "Creative Commons Attribution (CC-BY 4.0)"
  },
  "scenes": [
    {
      "image_filename": "CLEVR_train_000000.png",
      "objects": [
        {
          "shape": "cube",
          "size": "large",
          "material": "rubber",
          "color": "red",
          "3d_coords": [1.5, -2.0, 0.7],
          "pixel_coords": [160, 120, 0.85],
          "rotation": 45.0
        }
      ],
      "relationships": {
        "left": [...],
        "right": [...],
        "front": [...],
        "behind": [...]
      },
      "directions": {...}
    }
  ]
}
```

## Object Properties

The file `data/properties.json` defines allowed shapes, sizes, colors, and materials:

```json
{
  "shapes": {
    "cube": "SmoothCube_v2",
    "sphere": "Sphere",
    "cylinder": "SmoothCylinder"
  },
  "colors": {
    "gray": [87, 87, 87],
    "red": [173, 35, 35],
    "blue": [42, 75, 215],
    "green": [29, 105, 20],
    "brown": [129, 74, 25],
    "purple": [129, 38, 192],
    "cyan": [41, 208, 208],
    "yellow": [255, 238, 51]
  },
  "materials": {
    "rubber": "Rubber",
    "metal": "MyMetal"
  },
  "sizes": {
    "large": 0.7,
    "small": 0.35
  }
}
```

## CLEVR-CoGenT

To render CLEVR-CoGenT images with restricted shape-color combinations:

```bash
# Condition A
blender --background --python render_images.py -- \
    --shape_color_combos_json data/CoGenT_A.json \
    --num_images 1000

# Condition B
blender --background --python render_images.py -- \
    --shape_color_combos_json data/CoGenT_B.json \
    --num_images 1000
```

## Troubleshooting

### ImportError: cannot import utils

Ensure the `clevr.pth` file is in the correct site-packages directory and contains the path to this directory.

### GPU rendering fails

1. Check GPU drivers are installed
2. Verify CUDA/OptiX/HIP is available
3. Try running Blender GUI to check GPU settings

### Blender crashes during rendering

- Try reducing `--render_num_samples`
- Reduce image resolution
- Check available memory

### Objects keep getting replaced

This is normal behavior when objects overlap or are occluded. The script retries placement up to `--max_retries` times.

## Additional Documentation

- [Blender 5.0 Compatibility Guide](README_BLENDER5.md)
- [Main Project README](../README.md)
- [Complete Chinese Documentation](../CLEVR数据集生成工具完整报告.md)
